<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeta Network - R√©seau Social D√©centralis√© P2P</title>
    <meta name="description" content="Zeta Network - Un r√©seau social d√©centralis√© bas√© sur libp2p. Code Rust ex√©cut√© localement via WebAssembly.">
    
    <style>
        :root {
            --bg-primary: #15202b;
            --bg-secondary: #192734;
            --bg-tertiary: #22303c;
            --text-primary: #ffffff;
            --text-secondary: #8899a6;
            --accent-color: #1da1f2;
            --accent-hover: #1a91da;
            --success-color: #17bf63;
            --error-color: #e0245e;
            --border-color: #38444d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #loading-screen.hidden { display: none; }

        .loading-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        .loading-title {
            font-size: 2rem;
            margin-bottom: 30px;
        }

        .loading-steps {
            text-align: left;
            max-width: 400px;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            color: var(--text-secondary);
        }

        .loading-step.active { color: var(--accent-color); }
        .loading-step.done { color: var(--success-color); }
        .loading-step.error { color: var(--error-color); }

        .step-icon { width: 24px; text-align: center; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        /* Main App */
        #app { display: none; }
        #app.visible { display: block; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 15px; }

        .wasm-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-connected { background: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .status-disconnected { background: var(--error-color); }
        .status-connecting { background: #ffad1f; animation: pulse 1s infinite; }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .info-grid { display: grid; gap: 12px; }
        .info-item { display: flex; flex-direction: column; gap: 4px; }
        .info-item .label { color: var(--text-secondary); font-size: 0.85rem; }
        .info-item .value { font-family: monospace; font-size: 0.9rem; word-break: break-all; }

        .peers-list { max-height: 300px; overflow-y: auto; }

        .peer-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid var(--accent-color);
        }

        .peer-item .peer-icon { font-size: 1.5rem; }
        .peer-item .peer-info { flex: 1; }
        .peer-item .peer-name { font-weight: 500; }
        .peer-item .peer-id { font-family: monospace; font-size: 0.75rem; color: var(--text-secondary); }

        .relay-item {
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .relay-item.active { border-left: 3px solid var(--success-color); }

        .form-group { margin-bottom: 15px; }

        input, textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        textarea { resize: vertical; min-height: 80px; }

        .char-count {
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { background: var(--border-color); cursor: not-allowed; }

        .posts-feed { max-height: 600px; overflow-y: auto; }

        .post {
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        .post-local { border-left: 3px solid var(--accent-color); }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-author { font-weight: 600; }
        .post-time { font-size: 0.8rem; color: var(--text-secondary); }
        .post-content { margin-bottom: 10px; white-space: pre-wrap; word-break: break-word; }

        .post-footer {
            display: flex;
            justify-content: flex-end;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .empty-state {
            color: var(--text-secondary);
            text-align: center;
            padding: 30px;
            font-style: italic;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
        }

        footer a { color: var(--accent-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- √âcran de chargement -->
    <div id="loading-screen">
        <div class="loading-logo">üåê</div>
        <h1 class="loading-title">Zeta Network</h1>
        <div class="loading-steps">
            <div class="loading-step" id="step-wasm">
                <span class="step-icon">‚è≥</span>
                <span>Chargement du code Rust (WASM ~248KB)...</span>
            </div>
            <div class="loading-step" id="step-init">
                <span class="step-icon">‚è≥</span>
                <span>G√©n√©ration de votre identit√© ed25519...</span>
            </div>
            <div class="loading-step" id="step-connect">
                <span class="step-icon">‚è≥</span>
                <span>Connexion aux relais P2P...</span>
            </div>
            <div class="loading-step" id="step-ready">
                <span class="step-icon">‚è≥</span>
                <span>Synchronisation avec le r√©seau...</span>
            </div>
        </div>
    </div>

    <!-- Application principale -->
    <div id="app">
        <div class="container">
            <header>
                <h1>üåê Zeta Network</h1>
                <p class="subtitle">R√©seau social d√©centralis√© P2P</p>
                <div class="wasm-badge">
                    <span>ü¶Ä</span>
                    <span>Code Rust ex√©cut√© localement via WebAssembly</span>
                </div>
                <div class="connection-status">
                    <span id="connection-indicator" class="status-indicator status-disconnected"></span>
                    <span id="connection-text">D√©connect√©</span>
                </div>
            </header>

            <div class="main-content">
                <div class="info-section">
                    <div class="card">
                        <h2>üìä Votre N≈ìud</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Votre Peer ID (ed25519):</span>
                                <span class="value" id="local-peer-id">En attente...</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Cl√© publique:</span>
                                <span class="value" id="local-pubkey">-</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Mode:</span>
                                <span class="value"><span class="badge">ü¶Ä WASM + WebSocket</span></span>
                            </div>
                            <div class="info-item">
                                <span class="label">Pairs connect√©s:</span>
                                <span class="value" id="peer-count">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üì° Relais Connus</h2>
                        <div id="relays-list">
                            <!-- Dynamiquement rempli -->
                        </div>
                    </div>

                    <div class="card">
                        <h2>üë• Pairs sur le R√©seau <span id="peers-badge" class="badge">0</span></h2>
                        <div id="peers-list" class="peers-list">
                            <p class="empty-state">Recherche de pairs...</p>
                        </div>
                    </div>
                </div>

                <div class="posts-section">
                    <div class="card">
                        <h2>‚úçÔ∏è Publier un Message</h2>
                        <form id="post-form">
                            <div class="form-group">
                                <input 
                                    type="text" 
                                    id="author" 
                                    placeholder="Votre nom (pseudo)" 
                                    required
                                    maxlength="50"
                                >
                            </div>
                            <div class="form-group">
                                <textarea 
                                    id="content" 
                                    placeholder="Qu'avez-vous √† dire au monde ?" 
                                    required
                                    maxlength="280"
                                    rows="3"
                                ></textarea>
                                <div class="char-count">
                                    <span id="char-count">0</span>/280
                                </div>
                            </div>
                            <button type="submit" class="btn-primary" id="submit-btn">
                                üì§ Publier sur le r√©seau P2P
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>üì∞ Fil d'Actualit√© <span id="post-count-badge" class="badge">0</span></h2>
                        <div id="posts-feed" class="posts-feed">
                            <p class="empty-state">Aucun message pour le moment. Soyez le premier !</p>
                        </div>
                    </div>
                </div>
            </div>

            <footer>
                <p>ü¶Ä Code Rust ex√©cut√© via WebAssembly | üîê Cl√©s ed25519 g√©n√©r√©es localement | üåç <a href="https://github.com/cTHE0/Zeta_Network_test">Code source sur GitHub</a></p>
                <p style="margin-top: 10px; font-size: 0.8rem;">Vos cl√©s sont stock√©es dans votre navigateur. Aucun serveur central ne stocke vos donn√©es.</p>
            </footer>
        </div>
    </div>

    <!-- Configuration des relais connus -->
    <script>
        // =====================================================
        // LISTE DES RELAIS P2P CONNUS
        // Ces relais servent UNIQUEMENT √† transmettre les messages
        // Ils ne stockent pas vos donn√©es et ne peuvent pas lire vos messages
        // =====================================================
        window.KNOWN_RELAYS = [
            {
                name: "ServerCheap Primary",
                ws: "ws://65.75.201.11:3030/ws",
                api: "http://65.75.201.11:3030/api",
                location: "USA",
                p2p_port: 4001
            }
            // Ajoutez d'autres relais ici quand disponibles:
            // { name: "Europe Relay", ws: "ws://eu.zetanet.org:3030/ws", api: "...", location: "EU" },
            // { name: "Asia Relay", ws: "ws://asia.zetanet.org:3030/ws", api: "...", location: "Asia" },
        ];
    </script>

    <!-- Chargement du code Rust WASM -->
    <script type="module">
        // Import du module WASM compil√© depuis Rust
        import init, { 
            init as wasmInit,
            publish_post,
            get_peers,
            get_posts,
            on_message,
            on_peers_change,
            on_status_change,
            start_heartbeat,
            get_peer_id,
            get_public_key
        } from './pkg/zeta_wasm.js';

        // √âtat global
        let wasmReady = false;
        let currentRelay = null;
        let posts = [];
        let peers = [];

        // √âl√©ments DOM
        const $ = id => document.getElementById(id);

        // Mise √† jour des √©tapes de chargement
        function updateStep(stepId, status) {
            const step = $(stepId);
            step.className = `loading-step ${status}`;
            const icons = { active: 'üîÑ', done: '‚úÖ', error: '‚ùå', pending: '‚è≥' };
            step.querySelector('.step-icon').textContent = status === 'active' ? 'üîÑ' : icons[status];
            if (status === 'active') {
                step.querySelector('.step-icon').classList.add('spinner');
            } else {
                step.querySelector('.step-icon').classList.remove('spinner');
            }
        }

        // Afficher la liste des relais
        function displayRelays() {
            const container = $('relays-list');
            container.innerHTML = window.KNOWN_RELAYS.map((relay, i) => `
                <div class="relay-item ${currentRelay === i ? 'active' : ''}" id="relay-${i}">
                    <span>${currentRelay === i ? 'üü¢' : '‚ö™'}</span>
                    <span>${relay.name} (${relay.location})</span>
                </div>
            `).join('');
        }

        // Mise √† jour de l'interface
        function updateUI() {
            // Peer ID et cl√© publique
            try {
                const peerId = get_peer_id();
                const pubKey = get_public_key();
                $('local-peer-id').textContent = peerId ? peerId.substring(0, 16) + '...' : 'N/A';
                $('local-peer-id').title = peerId;
                $('local-pubkey').textContent = pubKey ? pubKey.substring(0, 20) + '...' : 'N/A';
                $('local-pubkey').title = pubKey;
            } catch (e) {
                console.warn('Peer info not available yet');
            }

            // Pairs
            $('peer-count').textContent = peers.length;
            $('peers-badge').textContent = peers.length;
            
            if (peers.length === 0) {
                $('peers-list').innerHTML = '<p class="empty-state">Recherche de pairs...</p>';
            } else {
                $('peers-list').innerHTML = peers.map(peer => `
                    <div class="peer-item">
                        <span class="peer-icon">üë§</span>
                        <div class="peer-info">
                            <span class="peer-name">${escapeHtml(peer.name || 'Anonyme')}</span>
                            <span class="peer-id">${peer.peer_id ? peer.peer_id.substring(0, 16) + '...' : 'N/A'}</span>
                        </div>
                    </div>
                `).join('');
            }

            // Posts
            $('post-count-badge').textContent = posts.length;
            
            if (posts.length === 0) {
                $('posts-feed').innerHTML = '<p class="empty-state">Aucun message. Soyez le premier !</p>';
            } else {
                $('posts-feed').innerHTML = posts.map(post => {
                    const date = new Date(post.timestamp * 1000);
                    const peerId = get_peer_id();
                    const isLocal = post.author === peerId;
                    
                    return `
                        <div class="post ${isLocal ? 'post-local' : ''}">
                            <div class="post-header">
                                <span class="post-author">${escapeHtml(post.author_name || 'Anonyme')}</span>
                                <span class="post-time">${getTimeAgo(date)}</span>
                            </div>
                            <div class="post-content">${escapeHtml(post.content)}</div>
                            <div class="post-footer">
                                <span>${isLocal ? 'üìç Vous' : 'üîó ' + (post.author ? post.author.substring(0, 12) + '...' : 'N/A')}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Callbacks du WASM
        function setupCallbacks() {
            // Nouveau message re√ßu
            on_message((msg) => {
                console.log('üì© Message re√ßu:', msg);
                try {
                    const data = typeof msg === 'string' ? JSON.parse(msg) : msg;
                    if (data.type === 'init') {
                        peers = data.peers || [];
                        posts = data.posts || [];
                        updateUI();
                    } else if (data.type === 'new_post' || data.Post) {
                        const post = data.post || data.Post || data;
                        if (post && post.id && !posts.find(p => p.id === post.id)) {
                            posts.unshift(post);
                            updateUI();
                        }
                    }
                } catch (e) {
                    console.error('Erreur parsing message:', e);
                }
            });

            // Changement de pairs
            on_peers_change((newPeers) => {
                console.log('üë• Pairs mis √† jour:', newPeers);
                peers = newPeers || [];
                updateUI();
            });

            // Changement de statut
            on_status_change((status) => {
                console.log('üì° Statut:', status);
                const indicator = $('connection-indicator');
                const text = $('connection-text');
                
                if (status === 'connected') {
                    indicator.className = 'status-indicator status-connected';
                    text.textContent = '‚úÖ Connect√© au r√©seau P2P';
                } else if (status === 'connecting') {
                    indicator.className = 'status-indicator status-connecting';
                    text.textContent = 'üîÑ Connexion...';
                } else {
                    indicator.className = 'status-indicator status-disconnected';
                    text.textContent = '‚ùå D√©connect√©';
                }
            });
        }

        // Initialisation principale
        async function main() {
            console.log('üöÄ Zeta Network - D√©marrage avec WASM...');
            console.log('üì° Relais connus:', window.KNOWN_RELAYS);
            
            displayRelays();
            
            try {
                // √âtape 1: Charger le WASM
                updateStep('step-wasm', 'active');
                console.log('üì¶ Chargement du module WASM...');
                await init();
                updateStep('step-wasm', 'done');
                
                // √âtape 2: Initialiser l'identit√©
                updateStep('step-init', 'active');
                console.log('üîë G√©n√©ration de l\'identit√© ed25519...');
                
                // S√©lectionner le premier relay disponible
                const relay = window.KNOWN_RELAYS[0];
                currentRelay = 0;
                displayRelays();
                
                // Initialiser le WASM avec l'URL du relay
                await wasmInit(relay.ws);
                updateStep('step-init', 'done');
                
                // √âtape 3: Configurer les callbacks et se connecter
                updateStep('step-connect', 'active');
                setupCallbacks();
                updateStep('step-connect', 'done');
                
                // √âtape 4: D√©marrer le heartbeat
                updateStep('step-ready', 'active');
                start_heartbeat();
                
                // Charger les donn√©es initiales
                try {
                    posts = get_posts() || [];
                    peers = get_peers() || [];
                } catch (e) {
                    console.warn('Initial data not available yet');
                }
                
                updateStep('step-ready', 'done');
                
                // Afficher l'application
                wasmReady = true;
                $('loading-screen').classList.add('hidden');
                $('app').classList.add('visible');
                updateUI();
                
                console.log('‚úÖ Zeta Network pr√™t!');
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                updateStep('step-wasm', 'error');
                updateStep('step-init', 'error');
                updateStep('step-connect', 'error');
                updateStep('step-ready', 'error');
            }
        }

        // Gestion du formulaire
        document.addEventListener('DOMContentLoaded', () => {
            const form = $('post-form');
            const authorInput = $('author');
            const contentInput = $('content');
            const charCount = $('char-count');
            const submitBtn = $('submit-btn');

            // Restaurer le nom sauvegard√©
            const savedName = localStorage.getItem('zeta_username');
            if (savedName) authorInput.value = savedName;

            // Compteur de caract√®res
            contentInput.addEventListener('input', () => {
                charCount.textContent = contentInput.value.length;
            });

            // Soumission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!wasmReady) {
                    alert('Le r√©seau n\'est pas encore pr√™t. Veuillez patienter...');
                    return;
                }

                const author = authorInput.value.trim();
                const content = contentInput.value.trim();
                
                if (!author || !content) return;
                
                localStorage.setItem('zeta_username', author);
                submitBtn.disabled = true;
                submitBtn.textContent = 'üì§ Envoi...';
                
                try {
                    // Appel au code Rust WASM pour publier
                    await publish_post(content, author);
                    contentInput.value = '';
                    charCount.textContent = '0';
                } catch (error) {
                    console.error('Erreur publication:', error);
                    alert('Erreur: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì§ Publier sur le r√©seau P2P';
                }
            });
        });

        // Utilitaires
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return '√Ä l\'instant';
            if (seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)}h`;
            return date.toLocaleDateString('fr-FR');
        }

        // D√©marrer
        main();
    </script>
</body>
</html>
