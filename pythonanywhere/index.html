<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeta Network - R√©seau Social D√©centralis√© P2P</title>
    <meta name="description" content="Zeta Network - R√©seau social d√©centralis√© P2P avec Rust et libp2p">
    <style>
        :root {
            --bg-primary: #15202b;
            --bg-secondary: #192734;
            --bg-tertiary: #22303c;
            --text-primary: #ffffff;
            --text-secondary: #8899a6;
            --accent-color: #1da1f2;
            --success-color: #17bf63;
            --error-color: #e0245e;
            --warning-color: #ffad1f;
            --border-color: #38444d;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { text-align: center; padding: 30px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: var(--text-secondary); margin-bottom: 15px; }
        .badge { display: inline-block; background: var(--accent-color); padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; margin: 5px; }
        .status { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 15px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-dot.connected { background: var(--success-color); box-shadow: 0 0 10px var(--success-color); }
        .status-dot.disconnected { background: var(--error-color); }
        .status-dot.connecting { background: var(--warning-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        
        /* Layout */
        .main { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        @media (max-width: 768px) { .main { grid-template-columns: 1fr; } }
        
        /* Cards */
        .card { background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .card h2 { font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .card h2 .count { background: var(--accent-color); padding: 2px 10px; border-radius: 10px; font-size: 0.85rem; }
        
        /* Info items */
        .info-item { margin-bottom: 10px; }
        .info-item .label { color: var(--text-secondary); font-size: 0.85rem; }
        .info-item .value { font-family: monospace; font-size: 0.9rem; word-break: break-all; }
        
        /* Relay list */
        .relay-list { max-height: 200px; overflow-y: auto; }
        .relay { padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; }
        .relay:hover { transform: translateX(5px); }
        .relay.active { border-left: 3px solid var(--success-color); background: rgba(23,191,99,0.1); }
        .relay.trying { border-left: 3px solid var(--warning-color); }
        .relay.failed { border-left: 3px solid var(--error-color); opacity: 0.6; }
        .relay-info { flex: 1; }
        .relay-name { font-weight: 500; }
        .relay-url { font-size: 0.75rem; color: var(--text-secondary); font-family: monospace; }
        
        /* Peer list */
        .peer { padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .peer-icon { font-size: 1.3rem; }
        .peer-info { flex: 1; }
        .peer-name { font-weight: 500; }
        .peer-id { font-size: 0.75rem; color: var(--text-secondary); font-family: monospace; }
        
        /* Forms */
        input, textarea { width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 1rem; margin-bottom: 10px; }
        input:focus, textarea:focus { outline: none; border-color: var(--accent-color); }
        textarea { resize: vertical; min-height: 80px; }
        .char-count { text-align: right; font-size: 0.8rem; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        button:hover { background: #1a91da; transform: translateY(-1px); }
        button:disabled { background: var(--border-color); cursor: not-allowed; transform: none; }
        button.secondary { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); }
        button.secondary:hover { background: rgba(29,161,242,0.1); }
        
        /* Posts */
        .posts { max-height: 500px; overflow-y: auto; }
        .post { padding: 15px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 12px; animation: fadeIn 0.3s; }
        .post.mine { border-left: 3px solid var(--accent-color); }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .post-author { font-weight: 600; }
        .post-time { color: var(--text-secondary); font-size: 0.8rem; }
        .post-content { white-space: pre-wrap; word-break: break-word; }
        .post-footer { margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary); text-align: right; }
        .empty { color: var(--text-secondary); text-align: center; padding: 30px; font-style: italic; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
        
        /* Alerts */
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .alert.warning { background: rgba(255,173,31,0.1); border: 1px solid var(--warning-color); }
        .alert.info { background: rgba(29,161,242,0.1); border: 1px solid var(--accent-color); }
        .alert h3 { margin-bottom: 10px; font-size: 1rem; }
        .alert p { font-size: 0.9rem; margin-bottom: 5px; }
        .alert a { color: var(--accent-color); }
        .alert code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-secondary); border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 20px; }
        .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 2rem; cursor: pointer; width: auto; padding: 0; }
        
        /* Footer */
        footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.85rem; border-top: 1px solid var(--border-color); margin-top: 20px; }
        footer a { color: var(--accent-color); text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê Zeta Network</h1>
            <p class="subtitle">R√©seau social d√©centralis√© P2P</p>
            <div>
                <span class="badge">ü¶Ä Rust</span>
                <span class="badge">üîó libp2p</span>
                <span class="badge">üîê ed25519</span>
            </div>
            <div class="status">
                <span id="status-dot" class="status-dot disconnected"></span>
                <span id="status-text">D√©connect√©</span>
            </div>
        </header>

        <!-- Alert box pour les erreurs -->
        <div id="alert-box" class="alert warning" style="display:none;">
            <h3 id="alert-title">‚ö†Ô∏è Information</h3>
            <p id="alert-message"></p>
        </div>

        <div class="main">
            <div class="sidebar">
                <div class="card">
                    <h2>üìä Votre N≈ìud</h2>
                    <div class="info-item">
                        <div class="label">Votre ID :</div>
                        <div class="value" id="my-id">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Nom :</div>
                        <div class="value" id="my-name">-</div>
                    </div>
                </div>

                <div class="card">
                    <h2>üì° Relais <span class="count" id="relay-count">0</span></h2>
                    <div id="relay-list" class="relay-list">
                        <p class="empty">Chargement...</p>
                    </div>
                    <button class="secondary" onclick="showAddRelay()" style="margin-top:10px;">‚ûï Ajouter un relais</button>
                </div>

                <div class="card">
                    <h2>üë• Pairs <span class="count" id="peer-count">0</span></h2>
                    <div id="peer-list">
                        <p class="empty">Aucun pair connect√©</p>
                    </div>
                </div>

                <div class="card">
                    <h2>üöÄ Devenir Relais</h2>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:10px;">
                        Aidez le r√©seau en devenant relais !
                    </p>
                    <button class="secondary" onclick="showBecomeRelay()">üìñ Instructions</button>
                </div>
            </div>

            <div class="content">
                <div class="card">
                    <h2>‚úçÔ∏è Publier un message</h2>
                    <input type="text" id="author" placeholder="Votre nom (pseudo)" maxlength="50">
                    <textarea id="content" placeholder="Qu'avez-vous √† dire au monde ?" maxlength="280" rows="3"></textarea>
                    <div class="char-count"><span id="char-count">0</span>/280</div>
                    <button id="send-btn" disabled>üì§ Publier sur le r√©seau P2P</button>
                </div>

                <div class="card">
                    <h2>üì∞ Messages <span class="count" id="post-count">0</span></h2>
                    <div id="posts" class="posts">
                        <p class="empty">Aucun message. Soyez le premier !</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>ü¶Ä Powered by Rust & libp2p | <a href="https://github.com/cTHE0/Zeta_Network_test" target="_blank">Code source</a></p>
            <p style="margin-top:5px;">Version JavaScript ‚Ä¢ <a href="#" onclick="showBecomeRelay();return false;">Devenir relais</a></p>
        </footer>
    </div>

    <!-- Modal Ajouter Relais -->
    <div id="modal-add-relay" class="modal">
        <div class="modal-content">
            <h2>‚ûï Ajouter un relais</h2>
            <p style="margin-bottom:15px;color:var(--text-secondary);">Entrez l'URL WebSocket d'un relais Zeta</p>
            <input type="text" id="new-relay-url" placeholder="wss://xxx.trycloudflare.com/ws">
            <input type="text" id="new-relay-name" placeholder="Nom du relais (optionnel)">
            <button onclick="addRelay()">Ajouter</button>
            <button class="secondary" onclick="closeModals()" style="margin-top:10px;">Annuler</button>
        </div>
    </div>

    <!-- Modal Devenir Relais -->
    <div id="modal-become-relay" class="modal">
        <div class="modal-content">
            <h2>üöÄ Devenir un relais Zeta</h2>
            <p style="margin-bottom:15px;color:var(--text-secondary);">
                Les relais aident √† connecter les utilisateurs entre eux. C'est simple et gratuit !
            </p>
            
            <h3 style="margin:20px 0 10px;">Option 1 : Une seule commande</h3>
            <div style="background:var(--bg-tertiary);padding:15px;border-radius:8px;margin-bottom:15px;">
                <code style="font-size:0.75rem;word-break:break-all;">curl -sSL https://raw.githubusercontent.com/cTHE0/Zeta_Network_test/main/run_relay.sh | bash</code>
            </div>
            <p style="font-size:0.85rem;color:var(--text-secondary);">
                ‚úÖ Installe automatiquement Rust et les d√©pendances<br>
                ‚úÖ Compile le relay<br>
                ‚úÖ Cr√©e un tunnel s√©curis√© (WSS)<br>
                ‚úÖ Affiche votre URL √† partager
            </p>

            <h3 style="margin:20px 0 10px;">Option 2 : Si d√©j√† clon√©</h3>
            <div style="background:var(--bg-tertiary);padding:15px;border-radius:8px;margin-bottom:15px;">
                <code>./run_relay.sh</code>
            </div>

            <h3 style="margin:20px 0 10px;">Pr√©requis</h3>
            <ul style="font-size:0.85rem;color:var(--text-secondary);padding-left:20px;">
                <li>Linux ou macOS</li>
                <li>Connexion internet</li>
                <li>~500 MB espace disque</li>
            </ul>

            <button class="secondary" onclick="closeModals()" style="margin-top:20px;">Fermer</button>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION - Liste des relais
        // L'URL WSS change √† chaque red√©marrage du tunnel.
        // Mettez √† jour ici ou ajoutez via l'interface.
        // =====================================================
        const DEFAULT_RELAYS = [
            // WSS (fonctionnent depuis HTTPS) - Cloudflare Tunnel
            // ‚ö†Ô∏è Cette URL change √† chaque red√©marrage du relay !
            { name: "Zeta Primary (WSS)", url: "wss://snap-self-days-win.trycloudflare.com/ws", wss: true },
            
            // Fallback WS (fonctionne seulement depuis HTTP)
            { name: "ServerCheap Direct (WS)", url: "ws://65.75.201.11:3030/ws", wss: false }
        ];

        // =====================================================
        // √âtat global
        // =====================================================
        let ws = null;
        let myPeerId = 'browser-' + Math.random().toString(36).substr(2, 8);
        let posts = [];
        let peers = [];
        let currentRelay = null;
        let relays = [...DEFAULT_RELAYS];
        let relayStatuses = {};
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        const $ = id => document.getElementById(id);
        const isHttps = location.protocol === 'https:';

        // Charger les relais custom depuis localStorage
        function loadCustomRelays() {
            try {
                const custom = JSON.parse(localStorage.getItem('zeta_custom_relays') || '[]');
                custom.forEach(r => {
                    if (!relays.find(existing => existing.url === r.url)) {
                        relays.unshift({ ...r, custom: true });
                    }
                });
            } catch (e) {}
        }

        function saveCustomRelays() {
            const custom = relays.filter(r => r.custom);
            localStorage.setItem('zeta_custom_relays', JSON.stringify(custom));
        }

        // =====================================================
        // Fonctions UI
        // =====================================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function timeAgo(timestamp) {
            const seconds = Math.floor((Date.now() / 1000) - timestamp);
            if (seconds < 60) return "√Ä l'instant";
            if (seconds < 3600) return `Il y a ${Math.floor(seconds/60)} min`;
            if (seconds < 86400) return `Il y a ${Math.floor(seconds/3600)}h`;
            return new Date(timestamp * 1000).toLocaleDateString('fr-FR');
        }

        function updateStatus(status, text) {
            $('status-dot').className = 'status-dot ' + status;
            $('status-text').textContent = text;
            $('send-btn').disabled = status !== 'connected';
        }

        function showAlert(title, message, type = 'warning') {
            $('alert-box').className = 'alert ' + type;
            $('alert-title').textContent = title;
            $('alert-message').innerHTML = message;
            $('alert-box').style.display = 'block';
        }

        function hideAlert() {
            $('alert-box').style.display = 'none';
        }

        function updateRelayList() {
            const container = $('relay-list');
            $('relay-count').textContent = relays.length;
            
            if (relays.length === 0) {
                container.innerHTML = '<p class="empty">Aucun relais configur√©</p>';
                return;
            }
            
            container.innerHTML = relays.map((relay, i) => {
                const status = relayStatuses[relay.url] || 'unknown';
                const statusClass = status === 'connected' ? 'active' : 
                                   status === 'trying' ? 'trying' : 
                                   status === 'failed' ? 'failed' : '';
                const icon = status === 'connected' ? 'üü¢' : 
                            status === 'trying' ? 'üü°' : 
                            status === 'failed' ? 'üî¥' : '‚ö™';
                const secureIcon = relay.wss ? 'üîí' : '‚ö†Ô∏è';
                const customBadge = relay.custom ? '<span style="font-size:0.7rem;color:var(--accent-color);">custom</span>' : '';
                
                return `<div class="relay ${statusClass}" onclick="connectToSpecificRelay(${i})">
                    <span>${icon}</span>
                    <div class="relay-info">
                        <div class="relay-name">${escapeHtml(relay.name)} ${secureIcon} ${customBadge}</div>
                        <div class="relay-url">${relay.url.substring(0, 40)}...</div>
                    </div>
                </div>`;
            }).join('');
        }

        function updatePeerList() {
            const container = $('peer-list');
            $('peer-count').textContent = peers.length;
            
            if (peers.length === 0) {
                container.innerHTML = '<p class="empty">Aucun pair connect√©</p>';
                return;
            }
            
            container.innerHTML = peers.map(peer => `
                <div class="peer">
                    <span class="peer-icon">${peer.is_browser ? 'üåê' : 'üíª'}</span>
                    <div class="peer-info">
                        <div class="peer-name">${escapeHtml(peer.name || 'Anonyme')}</div>
                        <div class="peer-id">${peer.peer_id ? peer.peer_id.substring(0, 16) + '...' : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function updatePosts() {
            const container = $('posts');
            $('post-count').textContent = posts.length;
            
            if (posts.length === 0) {
                container.innerHTML = '<p class="empty">Aucun message. Soyez le premier !</p>';
                return;
            }
            
            container.innerHTML = posts.map(post => {
                const isMine = post.author === myPeerId;
                return `
                    <div class="post ${isMine ? 'mine' : ''}">
                        <div class="post-header">
                            <span class="post-author">${escapeHtml(post.author_name || 'Anonyme')}</span>
                            <span class="post-time">${timeAgo(post.timestamp)}</span>
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        <div class="post-footer">${isMine ? 'üìç Vous' : 'üîó ' + (post.author || '').substring(0, 12) + '...'}</div>
                    </div>
                `;
            }).join('');
        }

        function updateMyInfo() {
            $('my-id').textContent = myPeerId;
            $('my-name').textContent = $('author').value || 'Anonyme';
        }

        // =====================================================
        // Modals
        // =====================================================
        function showAddRelay() {
            $('modal-add-relay').classList.add('show');
        }

        function showBecomeRelay() {
            $('modal-become-relay').classList.add('show');
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
        }

        function addRelay() {
            const url = $('new-relay-url').value.trim();
            const name = $('new-relay-name').value.trim() || 'Custom Relay';
            
            if (!url) {
                alert('Veuillez entrer une URL');
                return;
            }
            
            if (!url.startsWith('ws://') && !url.startsWith('wss://')) {
                alert('L\'URL doit commencer par ws:// ou wss://');
                return;
            }
            
            const isWss = url.startsWith('wss://');
            
            // V√©rifier si d√©j√† existant
            if (relays.find(r => r.url === url)) {
                alert('Ce relais existe d√©j√†');
                return;
            }
            
            relays.unshift({ name, url, wss: isWss, custom: true });
            saveCustomRelays();
            updateRelayList();
            closeModals();
            
            // Essayer de se connecter √† ce nouveau relais
            connectToSpecificRelay(0);
            
            $('new-relay-url').value = '';
            $('new-relay-name').value = '';
        }

        // =====================================================
        // Connexion WebSocket
        // =====================================================
        function connectToRelay(relayIndex = 0) {
            if (relayIndex >= relays.length) {
                updateStatus('disconnected', 'Aucun relais disponible');
                
                // Afficher aide si HTTPS et pas de WSS fonctionnel
                if (isHttps) {
                    const hasWorkingWss = relays.some(r => r.wss && relayStatuses[r.url] !== 'failed');
                    if (!hasWorkingWss) {
                        showAlert(
                            '‚ö†Ô∏è Connexion impossible',
                            'Ce site HTTPS ne peut pas se connecter aux relais WS non s√©curis√©s.<br><br>' +
                            '<strong>Solutions :</strong><br>' +
                            '‚Ä¢ Ajoutez un relais WSS (wss://...) via le bouton "Ajouter un relais"<br>' +
                            '‚Ä¢ Ou <a href="http://65.75.201.11:3030/" target="_blank">ouvrez la version HTTP</a>'
                        );
                    }
                }
                
                // Retry apr√®s d√©lai
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(() => connectToRelay(0), 5000 * reconnectAttempts);
                }
                return;
            }

            const relay = relays[relayIndex];
            
            // Skip WS relays if we're on HTTPS
            if (isHttps && !relay.wss) {
                console.log(`‚è≠Ô∏è Skip ${relay.name} (WS sur HTTPS)`);
                relayStatuses[relay.url] = 'skipped';
                updateRelayList();
                connectToRelay(relayIndex + 1);
                return;
            }

            console.log(`üîå Tentative: ${relay.name} (${relay.url})`);
            relayStatuses[relay.url] = 'trying';
            updateRelayList();
            updateStatus('connecting', `Connexion √† ${relay.name}...`);
            hideAlert();

            try {
                if (ws) {
                    ws.close();
                }
                
                ws = new WebSocket(relay.url);
                
                const timeout = setTimeout(() => {
                    if (ws && ws.readyState !== WebSocket.OPEN) {
                        console.log(`‚è±Ô∏è Timeout pour ${relay.name}`);
                        ws.close();
                        relayStatuses[relay.url] = 'failed';
                        updateRelayList();
                        connectToRelay(relayIndex + 1);
                    }
                }, 8000);

                ws.onopen = () => {
                    clearTimeout(timeout);
                    console.log(`‚úÖ Connect√© √† ${relay.name}`);
                    currentRelay = relay;
                    relayStatuses[relay.url] = 'connected';
                    reconnectAttempts = 0;
                    updateRelayList();
                    updateStatus('connected', `Connect√© via ${relay.name}`);
                    hideAlert();
                };

                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        handleMessage(data);
                    } catch (err) {
                        console.error('Parse error:', err);
                    }
                };

                ws.onclose = (e) => {
                    console.log('‚ùå D√©connect√©', e.code, e.reason);
                    if (currentRelay === relay) {
                        relayStatuses[relay.url] = 'failed';
                        updateRelayList();
                        updateStatus('disconnected', 'D√©connect√©');
                        currentRelay = null;
                        // Reconnexion apr√®s d√©lai
                        setTimeout(() => connectToRelay(0), 3000);
                    }
                };

                ws.onerror = (err) => {
                    console.error(`Erreur ${relay.name}:`, err);
                    clearTimeout(timeout);
                    relayStatuses[relay.url] = 'failed';
                    updateRelayList();
                    connectToRelay(relayIndex + 1);
                };
            } catch (err) {
                console.error('Connection error:', err);
                relayStatuses[relay.url] = 'failed';
                updateRelayList();
                connectToRelay(relayIndex + 1);
            }
        }

        function connectToSpecificRelay(index) {
            // Reset tous les status
            Object.keys(relayStatuses).forEach(k => relayStatuses[k] = 'unknown');
            connectToRelay(index);
        }

        function handleMessage(data) {
            console.log('üì©', data.type || data);
            
            if (data.type === 'init' || data.type === 'welcome') {
                if (data.peer_id) myPeerId = data.peer_id;
                peers = data.peers || [];
                posts = data.posts || data.recent_posts || [];
                updateMyInfo();
                updatePeerList();
                updatePosts();
            } else if (data.type === 'new_post' || data.Post) {
                const post = data.post || data.Post || data;
                if (post && post.id && !posts.find(p => p.id === post.id)) {
                    posts.unshift(post);
                    updatePosts();
                }
            } else if (data.type === 'peer_update' || data.type === 'peer_joined') {
                if (data.peers) peers = data.peers;
                else if (data.peer) peers.push(data.peer);
                updatePeerList();
            } else if (data.type === 'peer_left') {
                peers = peers.filter(p => p.peer_id !== data.peer_id);
                updatePeerList();
            }
        }

        function sendPost() {
            const author = $('author').value.trim();
            const content = $('content').value.trim();
            
            if (!author) {
                alert('Veuillez entrer votre nom');
                $('author').focus();
                return;
            }
            
            if (!content) {
                alert('Veuillez entrer un message');
                $('content').focus();
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Non connect√© au r√©seau');
                return;
            }
            
            localStorage.setItem('zeta_username', author);
            
            ws.send(JSON.stringify({
                type: 'post',
                content: content,
                author_name: author
            }));
            
            $('content').value = '';
            $('char-count').textContent = '0';
        }

        // =====================================================
        // Initialisation
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Charger les relais custom
            loadCustomRelays();
            
            // Restaurer le nom
            const savedName = localStorage.getItem('zeta_username');
            if (savedName) $('author').value = savedName;
            
            // Events
            $('send-btn').onclick = sendPost;
            $('content').oninput = () => {
                $('char-count').textContent = $('content').value.length;
            };
            $('content').onkeydown = (e) => {
                if (e.key === 'Enter' && e.ctrlKey) sendPost();
            };
            $('author').oninput = updateMyInfo;
            
            // Fermer modals en cliquant dehors
            document.querySelectorAll('.modal').forEach(modal => {
                modal.onclick = (e) => {
                    if (e.target === modal) closeModals();
                };
            });
            
            // Init UI
            updateMyInfo();
            updateRelayList();
            
            // Connect
            connectToRelay(0);
        });

        // Fermer avec Escape
        document.onkeydown = (e) => {
            if (e.key === 'Escape') closeModals();
        };
    </script>
</body>
</html>
